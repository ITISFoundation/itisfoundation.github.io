{
  "version": 3,
  "sources": [
    "/home/travis/build/ITISFoundation/osparc-simcore/services/web/client/source/class/qxapp/data/Permissions.js"
  ],
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "Class",
    "define",
    "extend",
    "core",
    "Object",
    "type",
    "construct",
    "initPermissions",
    "__getInitPermissions",
    "role",
    "prototype",
    "hasOwnProperty",
    "call",
    "forEach",
    "action",
    "addAction",
    "events",
    "statics",
    "ACTIONS",
    "ROLES",
    "anonymous",
    "can",
    "inherits",
    "guest",
    "user",
    "tester",
    "admin",
    "members",
    "__userRole",
    "__userLogin",
    "getRole",
    "setRole",
    "getLogin",
    "getChildrenRoles",
    "toLowerCase",
    "childrenRoles",
    "includes",
    "unshift",
    "children",
    "i",
    "length",
    "child",
    "moreChildren",
    "j",
    "__nextAction",
    "highestAction",
    "key",
    "push",
    "__canRoleDo",
    "roles",
    "roleObj",
    "indexOf",
    "some",
    "childRole",
    "canDo",
    "showMsg",
    "qxapp",
    "component",
    "message",
    "FlashMessenger",
    "getInstance",
    "logAs",
    "loadUserRoleFromBackend",
    "userResources",
    "io",
    "rest",
    "ResourceFactory",
    "createUserResources",
    "profile",
    "addListenerOnce",
    "e",
    "profileData",
    "getRequest",
    "getResponse",
    "data",
    "login",
    "fireDataEvent",
    "console",
    "error",
    "get",
    "Permissions"
  ],
  "mappings": ";;;;;;;;;;;;;;AAAAA,EAAAA,EAAE,CAACC,SAAH,CAAaC,oBAAb,CAAkCC,aAAlC;;AAAA;;;;;;;;;;;;;;;;;AAiBA;;;;;;;;;;;;;;;;;;AAmBAH,EAAAA,EAAE,CAACI,KAAH,CAASC,MAAT,CAAgB,wBAAhB,EAA0C;AACxCC,IAAAA,MAAM,EAAEN,EAAE,CAACO,IAAH,CAAQC,MADwB;AAGxCC,IAAAA,IAAI,EAAG,WAHiC;AAKxCC,IAAAA,SALwC,uBAK5B;AAAA;;AACV,UAAMC,eAAe,GAAG,KAAKC,oBAAL,EAAxB;;AADU,iCAECC,IAFD;AAGR,YAAIL,MAAM,CAACM,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCL,eAArC,EAAsDE,IAAtD,CAAJ,EAAiE;AAC/DF,UAAAA,eAAe,CAACE,IAAD,CAAf,CAAsBI,OAAtB,CAA8B,UAAAC,MAAM,EAAI;AACtC,YAAA,KAAI,CAACC,SAAL,CAAeN,IAAf,EAAqBK,MAArB;AACD,WAFD,EAEG,KAFH;AAGD;AAPO;;AAEV,WAAK,IAAML,IAAX,IAAmBF,eAAnB,EAAoC;AAAA,cAAzBE,IAAyB;AAMnC;AACF,KAduC;AAgBxCO,IAAAA,MAAM,EAAE;AACN,6BAAuB;AADjB,KAhBgC;AAoBxCC,IAAAA,OAAO,EAAE;AACPC,MAAAA,OAAO,EAAE,EADF;AAGPC,MAAAA,KAAK,EAAE;AACLC,QAAAA,SAAS,EAAE;AACTC,UAAAA,GAAG,EAAE,EADI;AAETC,UAAAA,QAAQ,EAAE;AAFD,SADN;AAKLC,QAAAA,KAAK,EAAE;AACLF,UAAAA,GAAG,EAAE,EADA;AAELC,UAAAA,QAAQ,EAAE,CAAC,WAAD;AAFL,SALF;AASLE,QAAAA,IAAI,EAAE;AACJH,UAAAA,GAAG,EAAE,EADD;AAEJC,UAAAA,QAAQ,EAAE,CAAC,OAAD;AAFN,SATD;AAaLG,QAAAA,MAAM,EAAE;AACNJ,UAAAA,GAAG,EAAE,EADC;AAENC,UAAAA,QAAQ,EAAE,CAAC,MAAD;AAFJ,SAbH;AAiBLI,QAAAA,KAAK,EAAE;AACLL,UAAAA,GAAG,EAAE,EADA;AAELC,UAAAA,QAAQ,EAAE,CAAC,QAAD;AAFL;AAjBF;AAHA,KApB+B;AA+CxCK,IAAAA,OAAO,EAAE;AACPC,MAAAA,UAAU,EAAE,IADL;AAEPC,MAAAA,WAAW,EAAE,IAFN;AAIPC,MAAAA,OAJO,qBAIG;AACR,eAAO,KAAKF,UAAZ;AACD,OANM;AAQPG,MAAAA,OARO,mBAQCtB,IARD,EAQO;AACZ,YAAI,CAAC,uBAAYU,KAAZ,CAAkBV,IAAlB,CAAL,EAA8B;AAC5B;AACD;;AACD,aAAKmB,UAAL,GAAkBnB,IAAlB;AACD,OAbM;AAePuB,MAAAA,QAfO,sBAeI;AACT,eAAO,KAAKH,WAAZ;AACD,OAjBM;AAmBPI,MAAAA,gBAnBO,4BAmBUxB,IAnBV,EAmBgB;AACrBA,QAAAA,IAAI,GAAGA,IAAI,CAACyB,WAAL,EAAP;AACA,YAAMC,aAAa,GAAG,EAAtB;;AACA,YAAI,CAAC,uBAAYhB,KAAZ,CAAkBV,IAAlB,CAAL,EAA8B;AAC5B,iBAAO0B,aAAP;AACD;;AACD,YAAI,CAACA,aAAa,CAACC,QAAd,CAAuB3B,IAAvB,CAAL,EAAmC;AACjC0B,UAAAA,aAAa,CAACE,OAAd,CAAsB5B,IAAtB;AACD;;AACD,YAAM6B,QAAQ,GAAG,uBAAYnB,KAAZ,CAAkBV,IAAlB,EAAwBa,QAAzC;;AACA,aAAK,IAAIiB,CAAC,GAAC,CAAX,EAAcA,CAAC,GAACD,QAAQ,CAACE,MAAzB,EAAiCD,CAAC,EAAlC,EAAsC;AACpC,cAAME,KAAK,GAAGH,QAAQ,CAACC,CAAD,CAAtB;;AACA,cAAI,CAACJ,aAAa,CAACC,QAAd,CAAuBK,KAAvB,CAAL,EAAoC;AAClCN,YAAAA,aAAa,CAACE,OAAd,CAAsBI,KAAtB;AACA,gBAAMC,YAAY,GAAG,KAAKT,gBAAL,CAAsBQ,KAAtB,CAArB;;AACA,iBAAK,IAAIE,CAAC,GAACD,YAAY,CAACF,MAAb,GAAoB,CAA/B,EAAkCG,CAAC,IAAE,CAArC,EAAwCA,CAAC,EAAzC,EAA6C;AAC3C,kBAAI,CAACR,aAAa,CAACC,QAAd,CAAuBM,YAAY,CAACC,CAAD,CAAnC,CAAL,EAA8C;AAC5CR,gBAAAA,aAAa,CAACE,OAAd,CAAsBK,YAAY,CAACC,CAAD,CAAlC;AACD;AACF;AACF;AACF;;AACD,eAAOR,aAAP;AACD,OA1CM;AA4CP3B,MAAAA,oBAAoB,EAAE,gCAAW;AAC/B,eAAO;AACL,uBAAa,EADR;AAEL,mBAAS,CACP,wBADO,EAEP,sBAFO,EAGP,aAHO,EAIP,YAJO,EAKP,cALO,CAFJ;AASL,kBAAQ,CACN,mBADM,EAEN,qBAFM,EAGN,sBAHM,EAIN,yBAJM,EAKN,0BALM,EAMN,0BANM,EAON,mBAPM,EAQN,mBARM,EASN,mBATM,EAUN,kBAVM,EAWN,sBAXM,EAYN,wBAZM,EAaN,mBAbM,EAcN,mBAdM,CATH;AAyBL,oBAAU,CACR,mBADQ,EAER,yBAFQ,EAGR,2BAHQ,EAIR,2BAJQ,EAKR,yBALQ,EAMR,yBANQ,EAOR,yBAPQ,EAQR,yBARQ,CAzBL;AAmCL,mBAAS;AAnCJ,SAAP;AAqCD,OAlFM;AAoFPoC,MAAAA,YAAY,EAAE,wBAAW;AACvB,YAAIC,aAAa,GAAG,GAApB;;AACA,aAAK,IAAMC,GAAX,IAAkB,uBAAY5B,OAA9B,EAAuC;AACrC,cAAI2B,aAAa,GAAG,uBAAY3B,OAAZ,CAAoB4B,GAApB,CAApB,EAA8C;AAC5CD,YAAAA,aAAa,GAAG,uBAAY3B,OAAZ,CAAoB4B,GAApB,CAAhB;AACD;AACF;;AACD,eAAO,IAAED,aAAT;AACD,OA5FM;AA8FP9B,MAAAA,SAAS,EAAE,mBAASN,IAAT,EAAeK,MAAf,EAAuB;AAChC,YAAI,CAAC,uBAAYK,KAAZ,CAAkBV,IAAlB,CAAL,EAA8B;AAC5B;AACD;;AAED,+BAAYS,OAAZ,CAAoBJ,MAApB,IAA8B,KAAK8B,YAAL,EAA9B;AACA,+BAAYzB,KAAZ,CAAkBV,IAAlB,EAAwBY,GAAxB,CAA4B0B,IAA5B,CAAiCjC,MAAjC;AACD,OArGM;AAuGP;AACAkC,MAAAA,WAAW,EAAE,qBAASvC,IAAT,EAAeK,MAAf,EAAuB;AAAA;;AAClCL,QAAAA,IAAI,GAAGA,IAAI,CAACyB,WAAL,EAAP,CADkC,CAElC;;AACA,YAAMe,KAAK,GAAG,uBAAY9B,KAA1B;;AACA,YAAI,CAAC8B,KAAK,CAACxC,IAAD,CAAV,EAAkB;AAChB,iBAAO,KAAP;AACD;;AACD,YAAIyC,OAAO,GAAGD,KAAK,CAACxC,IAAD,CAAnB,CAPkC,CAQlC;;AACA,YAAIyC,OAAO,CAAC7B,GAAR,CAAY8B,OAAZ,CAAoBrC,MAApB,MAAgC,CAAC,CAArC,EAAwC;AACtC,iBAAO,IAAP;AACD,SAXiC,CAYlC;;;AACA,YAAI,CAACoC,OAAO,CAAC5B,QAAT,IAAqB4B,OAAO,CAAC5B,QAAR,CAAiBkB,MAAjB,GAA0B,CAAnD,EAAsD;AACpD,iBAAO,KAAP;AACD,SAfiC,CAgBlC;;;AACA,eAAOU,OAAO,CAAC5B,QAAR,CAAiB8B,IAAjB,CAAsB,UAAAC,SAAS;AAAA,iBAAI,MAAI,CAACL,WAAL,CAAiBK,SAAjB,EAA4BvC,MAA5B,CAAJ;AAAA,SAA/B,CAAP;AACD,OA1HM;AA4HPwC,MAAAA,KAAK,EAAE,eAASxC,MAAT,EAAiByC,OAAjB,EAA0B;AAC/B,YAAID,KAAK,GAAG,KAAZ;;AACA,YAAI,KAAK1B,UAAT,EAAqB;AACnB0B,UAAAA,KAAK,GAAG,KAAKN,WAAL,CAAiB,KAAKpB,UAAtB,EAAkCd,MAAlC,CAAR;AACD;;AACD,YAAIyC,OAAO,IAAI,CAACD,KAAhB,EAAuB;AACrBE,UAAAA,KAAK,CAACC,SAAN,CAAgBC,OAAhB,CAAwBC,cAAxB,CAAuCC,WAAvC,GAAqDC,KAArD,CAA2D,yBAA3D,EAAsF,OAAtF;AACD;;AACD,eAAOP,KAAP;AACD,OArIM;AAuIPQ,MAAAA,uBAAuB,EAAE,mCAAW;AAAA;;AAClC,YAAIC,aAAa,GAAGP,KAAK,CAACQ,EAAN,CAASC,IAAT,CAAcC,eAAd,CAA8BN,WAA9B,GAA4CO,mBAA5C,EAApB;AAEA,YAAIC,OAAO,GAAGL,aAAa,CAACK,OAA5B;AACAA,QAAAA,OAAO,CAACC,eAAR,CAAwB,YAAxB,EAAsC,UAAAC,CAAC,EAAI;AACzC,cAAIC,WAAW,GAAGD,CAAC,CAACE,UAAF,GAAeC,WAAf,GAA6BC,IAA/C;AACA,UAAA,MAAI,CAAC9C,UAAL,GAAkB2C,WAAW,CAAC9D,IAA9B;AACA,UAAA,MAAI,CAACoB,WAAL,GAAmB0C,WAAW,CAACI,KAA/B;;AACA,UAAA,MAAI,CAACC,aAAL,CAAmB,qBAAnB,EAA0C,IAA1C;AACD,SALD,EAKG,IALH;AAMAR,QAAAA,OAAO,CAACC,eAAR,CAAwB,UAAxB,EAAoC,UAAAC,CAAC,EAAI;AACvCO,UAAAA,OAAO,CAACC,KAAR,CAAcR,CAAd;AACD,SAFD;AAGAF,QAAAA,OAAO,CAACW,GAAR;AACD;AArJM;AA/C+B,GAA1C;AApCAvB,EAAAA,KAAK,CAACkB,IAAN,CAAWM,WAAX,CAAuBjF,aAAvB,GAAuCA,aAAvC",
  "sourcesContent": [
    "/* ************************************************************************\n\n   qxapp - the simcore frontend\n\n   https://osparc.io\n\n   Copyright:\n     2018 IT'IS Foundation, https://itis.swiss\n\n   License:\n     MIT: https://opensource.org/licenses/MIT\n\n   Authors:\n     * Odei Maiz (odeimaiz)\n\n************************************************************************ */\n\n/**\n * Singleton class for building Permission table and check doable operations.\n *\n * It implements HRBAC (Hierarchical Role Based Access Control) permission model.\n *\n * It is able to:\n * - add Actions to build a table of permissions\n * - load User's Role from the backend\n * - check whether a role can do a specific actions\n *\n * *Example*\n *\n * Here is a little example of how to use the class.\n *\n * <pre class='javascript'>\n *   qxapp.data.Permissions.getInstance().canDo(\"study.start\", true)\n * </pre>\n */\n\nqx.Class.define(\"qxapp.data.Permissions\", {\n  extend: qx.core.Object,\n\n  type : \"singleton\",\n\n  construct() {\n    const initPermissions = this.__getInitPermissions();\n    for (const role in initPermissions) {\n      if (Object.prototype.hasOwnProperty.call(initPermissions, role)) {\n        initPermissions[role].forEach(action => {\n          this.addAction(role, action);\n        }, this);\n      }\n    }\n  },\n\n  events: {\n    \"userProfileRecieved\": \"qx.event.type.Event\"\n  },\n\n  statics: {\n    ACTIONS: {},\n\n    ROLES: {\n      anonymous: {\n        can: [],\n        inherits: []\n      },\n      guest: {\n        can: [],\n        inherits: [\"anonymous\"]\n      },\n      user: {\n        can: [],\n        inherits: [\"guest\"]\n      },\n      tester: {\n        can: [],\n        inherits: [\"user\"]\n      },\n      admin: {\n        can: [],\n        inherits: [\"tester\"]\n      }\n    }\n  },\n\n  members: {\n    __userRole: null,\n    __userLogin: null,\n\n    getRole() {\n      return this.__userRole;\n    },\n\n    setRole(role) {\n      if (!this.self().ROLES[role]) {\n        return;\n      }\n      this.__userRole = role;\n    },\n\n    getLogin() {\n      return this.__userLogin;\n    },\n\n    getChildrenRoles(role) {\n      role = role.toLowerCase();\n      const childrenRoles = [];\n      if (!this.self().ROLES[role]) {\n        return childrenRoles;\n      }\n      if (!childrenRoles.includes(role)) {\n        childrenRoles.unshift(role);\n      }\n      const children = this.self().ROLES[role].inherits;\n      for (let i=0; i<children.length; i++) {\n        const child = children[i];\n        if (!childrenRoles.includes(child)) {\n          childrenRoles.unshift(child);\n          const moreChildren = this.getChildrenRoles(child);\n          for (let j=moreChildren.length-1; j>=0; j--) {\n            if (!childrenRoles.includes(moreChildren[j])) {\n              childrenRoles.unshift(moreChildren[j]);\n            }\n          }\n        }\n      }\n      return childrenRoles;\n    },\n\n    __getInitPermissions: function() {\n      return {\n        \"anonymous\": [],\n        \"guest\": [\n          \"studies.templates.read\",\n          \"study.node.data.pull\",\n          \"study.start\",\n          \"study.stop\",\n          \"study.update\"\n        ],\n        \"user\": [\n          \"studies.user.read\",\n          \"studies.user.create\",\n          \"storage.datcore.read\",\n          \"preferences.user.update\",\n          \"preferences.token.create\",\n          \"preferences.token.delete\",\n          \"study.node.create\",\n          \"study.node.delete\",\n          \"study.node.rename\",\n          \"study.node.start\",\n          \"study.node.data.push\",\n          \"study.node.data.delete\",\n          \"study.edge.create\",\n          \"study.edge.delete\"\n        ],\n        \"tester\": [\n          \"services.all.read\",\n          \"preferences.role.update\",\n          \"study.nodestree.uuid.read\",\n          \"study.filestree.uuid.read\",\n          \"study.logger.debug.read\",\n          \"studies.template.create\",\n          \"studies.template.update\",\n          \"studies.template.delete\"\n        ],\n        \"admin\": []\n      };\n    },\n\n    __nextAction: function() {\n      let highestAction = 0.5;\n      for (const key in this.self().ACTIONS) {\n        if (highestAction < this.self().ACTIONS[key]) {\n          highestAction = this.self().ACTIONS[key];\n        }\n      }\n      return 2*highestAction;\n    },\n\n    addAction: function(role, action) {\n      if (!this.self().ROLES[role]) {\n        return;\n      }\n\n      this.self().ACTIONS[action] = this.__nextAction();\n      this.self().ROLES[role].can.push(action);\n    },\n\n    // https://blog.nodeswat.com/implement-access-control-in-node-js-8567e7b484d1#2405\n    __canRoleDo: function(role, action) {\n      role = role.toLowerCase();\n      // Check if role exists\n      const roles = this.self().ROLES;\n      if (!roles[role]) {\n        return false;\n      }\n      let roleObj = roles[role];\n      // Check if this role has access\n      if (roleObj.can.indexOf(action) !== -1) {\n        return true;\n      }\n      // Check if there are any parents\n      if (!roleObj.inherits || roleObj.inherits.length < 1) {\n        return false;\n      }\n      // Check child roles until one returns true or all return false\n      return roleObj.inherits.some(childRole => this.__canRoleDo(childRole, action));\n    },\n\n    canDo: function(action, showMsg) {\n      let canDo = false;\n      if (this.__userRole) {\n        canDo = this.__canRoleDo(this.__userRole, action);\n      }\n      if (showMsg && !canDo) {\n        qxapp.component.message.FlashMessenger.getInstance().logAs(\"Operation not permitted\", \"ERROR\");\n      }\n      return canDo;\n    },\n\n    loadUserRoleFromBackend: function() {\n      let userResources = qxapp.io.rest.ResourceFactory.getInstance().createUserResources();\n\n      let profile = userResources.profile;\n      profile.addListenerOnce(\"getSuccess\", e => {\n        let profileData = e.getRequest().getResponse().data;\n        this.__userRole = profileData.role;\n        this.__userLogin = profileData.login;\n        this.fireDataEvent(\"userProfileRecieved\", true);\n      }, this);\n      profile.addListenerOnce(\"getError\", e => {\n        console.error(e);\n      });\n      profile.get();\n    }\n  }\n});\n"
  ]
}